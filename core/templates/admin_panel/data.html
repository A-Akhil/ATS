{% extends 'base.html' %}

{% block title %}Data Viewer{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-12">
	<div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-purple-700 text-white rounded-3xl shadow-xl px-8 py-10">
		<h1 class="text-3xl sm:text-4xl font-bold">Platform Data Viewer</h1>
		<p class="mt-3 text-sm sm:text-base opacity-90 max-w-2xl">
			Review the latest records across users, resumes, job descriptions, and match attempts without leaving the custom admin experience.
		</p>
	</div>

	<section class="bg-white rounded-3xl shadow-xl border border-gray-100">
		<header class="flex items-center justify-between px-6 py-5 border-b border-gray-100">
			<div>
				<h2 class="text-lg font-semibold text-gray-900">Recent Users</h2>
				<p class="text-sm text-gray-500">Newest 50 accounts in the system.</p>
			</div>
			<i class="fas fa-user-friends text-indigo-500 text-xl"></i>
		</header>
		{% if users %}
		<div class="overflow-x-auto">
			<div class="max-h-96 overflow-y-auto">
			<table class="min-w-full divide-y divide-gray-100">
				<thead class="bg-gray-50 text-gray-600 text-xs uppercase tracking-wide">
					<tr>
						<th class="px-6 py-3 text-left">Email</th>
						<th class="px-6 py-3 text-left">Role</th>
						<th class="px-6 py-3 text-left">Created</th>
						<th class="px-6 py-3 text-left">Phone</th>
						<th class="px-6 py-3 text-left">Actions</th>
					</tr>
				</thead>
				<tbody class="divide-y divide-gray-100 text-sm">
					{% for user in users %}
					<tr class="hover:bg-gray-50 transition">
						<td class="px-6 py-4">
							<p class="font-medium text-gray-900">{{ user.email }}</p>
							<p class="text-xs text-gray-500">{{ user.first_name }} {{ user.last_name }}</p>
						</td>
						<td class="px-6 py-4">
							<span class="text-xs px-2 py-1 rounded-full border {% if user.role == 'admin' %}border-purple-200 text-purple-600 bg-purple-50{% else %}border-gray-200 text-gray-600 bg-gray-50{% endif %}">
								{{ user.get_role_display }}
							</span>
						</td>
						<td class="px-6 py-4 text-xs text-gray-500">{{ user.created_at|date:"M d, Y - g:i A" }}</td>
						<td class="px-6 py-4 text-xs text-gray-500">{{ user.phone|default:"-" }}</td>
						<td class="px-6 py-4">
							<button type="button" class="inline-flex items-center gap-2 px-4 py-2 rounded-full border border-gray-200 text-gray-700 hover:bg-gray-100 text-xs font-semibold" onclick="document.getElementById('user-modal-{{ user.id }}').classList.remove('hidden')">
								<i class="fas fa-eye"></i> View Details
							</button>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
			</div>
		</div>
		{% else %}
		<p class="px-6 py-10 text-center text-gray-500">No users found.</p>
		{% endif %}
	</section>

		{% if users %}
		{% for user in users %}
		<div id="user-modal-{{ user.id }}" class="user-modal hidden fixed inset-0 z-50 flex items-start justify-center bg-black/40 px-4 py-10 overflow-y-auto" onclick="if(event.target === this) { this.classList.add('hidden'); }">
			<div class="relative max-w-3xl w-full bg-white rounded-3xl shadow-2xl border border-gray-100">
				<div class="sticky top-0 flex items-center justify-between px-6 py-4 border-b border-gray-100 bg-white rounded-t-3xl">
					<div>
						<h3 class="text-lg font-semibold text-gray-900">{{ user.first_name }} {{ user.last_name }}</h3>
						<p class="text-sm text-gray-500">{{ user.email }}</p>
					</div>
					<button type="button" class="text-gray-400 hover:text-gray-600" onclick="this.closest('.user-modal').classList.add('hidden')">
						<i class="fas fa-times text-lg"></i>
					</button>
				</div>
				<div class="px-6 py-6 space-y-8">
					<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-gray-700">
						<p><span class="font-semibold text-gray-900">Role:</span> {{ user.get_role_display }}</p>
						<p><span class="font-semibold text-gray-900">Phone:</span> {{ user.phone|default:"-" }}</p>
						<p><span class="font-semibold text-gray-900">Location:</span> {% if user.profile %}{{ user.profile.city|default:"" }}{% if user.profile.city and user.profile.state %}, {% endif %}{{ user.profile.state|default:"" }}{% else %}-{% endif %}</p>
						<p><span class="font-semibold text-gray-900">LinkedIn:</span> {% if user.profile and user.profile.linkedin %}<a href="{{ user.profile.linkedin }}" class="text-indigo-600 hover:underline" target="_blank" rel="noopener">{{ user.profile.linkedin }}</a>{% else %}-{% endif %}</p>
						<p><span class="font-semibold text-gray-900">GitHub:</span> {% if user.profile and user.profile.github %}<a href="{{ user.profile.github }}" class="text-indigo-600 hover:underline" target="_blank" rel="noopener">{{ user.profile.github }}</a>{% else %}-{% endif %}</p>
						<p><span class="font-semibold text-gray-900">Joined:</span> {{ user.created_at|date:"M d, Y - g:i A" }}</p>
					</div>

					{% if user.profile and user.profile.summary %}
					<div>
						<h4 class="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-2">Professional Summary</h4>
						<p class="text-sm text-gray-700 whitespace-pre-wrap">{{ user.profile.summary }}</p>
					</div>
					{% endif %}

					<div class="grid grid-cols-1 gap-6">
						{% with profile=user.profile %}
						{% if profile and profile.education_entries %}
						<div>
							<h4 class="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3">Education</h4>
							<ul class="space-y-3 text-sm text-gray-700">
								{% for edu in profile.education_entries %}
								<li class="bg-gray-50 rounded-2xl px-4 py-3">
									<p class="font-semibold text-gray-900">{{ edu.degree }} in {{ edu.field }}</p>
									<p class="text-xs text-gray-500">{{ edu.institution }} | {{ edu.start_year }} - {{ edu.end_year }}</p>
									{% if edu.gpa %}<p class="text-xs text-gray-500">GPA: {{ edu.gpa }}</p>{% endif %}
								</li>
								{% endfor %}
							</ul>
						</div>
						{% endif %}

						{% if profile and profile.experiences %}
						<div>
							<h4 class="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3">Experience</h4>
							<ul class="space-y-3 text-sm text-gray-700">
								{% for exp in profile.experiences %}
								<li class="bg-gray-50 rounded-2xl px-4 py-3">
									<p class="font-semibold text-gray-900">{{ exp.title }} - {{ exp.company }}</p>
									<p class="text-xs text-gray-500">{{ exp.start }} - {{ exp.end }}</p>
									{% if exp.description %}
									<p class="mt-2 text-sm text-gray-700 whitespace-pre-wrap">{{ exp.description }}</p>
									{% endif %}
									{% if exp.responsibilities %}
									<ul class="mt-2 list-disc list-inside text-xs text-gray-600 space-y-1">
										{% for item in exp.responsibilities %}
										<li>{{ item }}</li>
										{% endfor %}
									</ul>
									{% endif %}
								</li>
								{% endfor %}
							</ul>
						</div>
						{% endif %}

						{% if profile and profile.projects %}
						<div>
							<h4 class="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3">Projects</h4>
							<ul class="space-y-3 text-sm text-gray-700">
								{% for project in profile.projects %}
								<li class="bg-gray-50 rounded-2xl px-4 py-3">
									<p class="font-semibold text-gray-900">{{ project.name }}</p>
									{% if project.description %}<p class="mt-2 text-sm text-gray-700 whitespace-pre-wrap">{{ project.description }}</p>{% endif %}
									{% if project.technologies %}<p class="text-xs text-gray-500 mt-1">Tech: {{ project.technologies }}</p>{% endif %}
									{% if project.link %}<a class="text-xs text-indigo-600 hover:underline" href="{{ project.link }}" target="_blank" rel="noopener">View Project</a>{% endif %}
								</li>
								{% endfor %}
							</ul>
						</div>
						{% endif %}

						{% if profile and profile.certifications %}
						<div>
							<h4 class="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3">Certifications</h4>
							<ul class="space-y-3 text-sm text-gray-700">
								{% for cert in profile.certifications %}
								<li class="bg-gray-50 rounded-2xl px-4 py-3">
									<p class="font-semibold text-gray-900">{{ cert.name }}</p>
									<p class="text-xs text-gray-500">{{ cert.issuer }}{% if cert.date %} &bull; {{ cert.date }}{% endif %}</p>
									{% if cert.credential_id %}<p class="text-xs text-gray-500">Credential ID: {{ cert.credential_id }}</p>{% endif %}
								</li>
								{% endfor %}
							</ul>
						</div>
						{% endif %}

						{% if profile and profile.publications %}
						<div>
							<h4 class="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3">Publications</h4>
							<ul class="space-y-3 text-sm text-gray-700">
								{% for pub in profile.publications %}
								<li class="bg-gray-50 rounded-2xl px-4 py-3">
									<p class="font-semibold text-gray-900">{{ pub.title }}</p>
									<p class="text-xs text-gray-500">{{ pub.venue }}{% if pub.date %} &bull; {{ pub.date }}{% endif %}</p>
									{% if pub.description %}<p class="mt-2 text-sm text-gray-700 whitespace-pre-wrap">{{ pub.description }}</p>{% endif %}
									{% if pub.link %}<a class="text-xs text-indigo-600 hover:underline" href="{{ pub.link }}" target="_blank" rel="noopener">Read Publication</a>{% endif %}
								</li>
								{% endfor %}
							</ul>
						</div>
						{% endif %}

						{% if profile and profile.achievements %}
						<div>
							<h4 class="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3">Achievements</h4>
							<ul class="space-y-3 text-sm text-gray-700">
								{% for award in profile.achievements %}
								<li class="bg-gray-50 rounded-2xl px-4 py-3">
									<p class="font-semibold text-gray-900">{{ award.name }}</p>
									<p class="text-xs text-gray-500">{{ award.organization }}{% if award.level %} &bull; {{ award.level }}{% endif %}</p>
								</li>
								{% endfor %}
							</ul>
						</div>
						{% endif %}

						{% if profile and profile.leadership %}
						<div>
							<h4 class="text-sm font-semibold text-gray-900 uppercase tracking-wide mb-3">Leadership</h4>
							<ul class="space-y-3 text-sm text-gray-700">
								{% for lead in profile.leadership %}
								<li class="bg-gray-50 rounded-2xl px-4 py-3">
									<p class="font-semibold text-gray-900">{{ lead.role }}</p>
									<p class="text-xs text-gray-500">{{ lead.organization }}{% if lead.location %} &bull; {{ lead.location }}{% endif %}</p>
									{% if lead.description %}<p class="mt-2 text-sm text-gray-700 whitespace-pre-wrap">{{ lead.description }}</p>{% endif %}
								</li>
								{% endfor %}
							</ul>
						</div>
						{% endif %}
						{% endwith %}
					</div>
				</div>
				<div class="flex justify-end px-6 py-4 border-t border-gray-100 bg-gray-50 rounded-b-3xl">
					<button type="button" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700" onclick="this.closest('.user-modal').classList.add('hidden')">
						<i class="fas fa-times"></i> Close
					</button>
				</div>
			</div>
		</div>
		{% endfor %}
		{% endif %}

	<section class="bg-white rounded-3xl shadow-xl border border-gray-100">
		<header class="flex items-center justify-between px-6 py-5 border-b border-gray-100">
			<div>
				<h2 class="text-lg font-semibold text-gray-900">Latest Resumes</h2>
				<p class="text-sm text-gray-500">Most recent 50 resume records.</p>
			</div>
			<i class="fas fa-file-alt text-green-500 text-xl"></i>
		</header>
		{% if resumes %}
		<div class="overflow-x-auto">
			<div class="max-h-96 overflow-y-auto">
			<table class="min-w-full divide-y divide-gray-100">
				<thead class="bg-gray-50 text-gray-600 text-xs uppercase tracking-wide">
					<tr>
						<th class="px-6 py-3 text-left">Owner</th>
						<th class="px-6 py-3 text-left">Source</th>
						<th class="px-6 py-3 text-left">Filename</th>
						<th class="px-6 py-3 text-left">Created</th>
					</tr>
				</thead>
				<tbody class="divide-y divide-gray-100 text-sm">
					{% for resume in resumes %}
					<tr class="hover:bg-gray-50 transition">
						<td class="px-6 py-4">
							<p class="font-medium text-gray-900">{{ resume.user.email }}</p>
						</td>
						<td class="px-6 py-4 text-xs text-gray-500">{{ resume.get_source_type_display }}</td>
						<td class="px-6 py-4 text-xs text-gray-500">{{ resume.filename|default:"-" }}</td>
						<td class="px-6 py-4 text-xs text-gray-500">{{ resume.created_at|date:"M d, Y - g:i A" }}</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
			</div>
		</div>
		{% else %}
		<p class="px-6 py-10 text-center text-gray-500">No resumes found.</p>
		{% endif %}
	</section>

	<section class="bg-white rounded-3xl shadow-xl border border-gray-100">
		<header class="flex items-center justify-between px-6 py-5 border-b border-gray-100">
			<div>
				<h2 class="text-lg font-semibold text-gray-900">Job Descriptions</h2>
				<p class="text-sm text-gray-500">Most recent 50 job descriptions uploaded.</p>
			</div>
			<i class="fas fa-briefcase text-amber-500 text-xl"></i>
		</header>
		{% if job_descriptions %}
		<div class="overflow-x-auto">
			<div class="max-h-96 overflow-y-auto">
			<table class="min-w-full divide-y divide-gray-100">
				<thead class="bg-gray-50 text-gray-600 text-xs uppercase tracking-wide">
					<tr>
						<th class="px-6 py-3 text-left">Title</th>
						<th class="px-6 py-3 text-left">Owner</th>
						<th class="px-6 py-3 text-left">Created</th>
						<th class="px-6 py-3 text-left">Excerpt</th>
					</tr>
				</thead>
				<tbody class="divide-y divide-gray-100 text-sm">
					{% for job in job_descriptions %}
					<tr class="hover:bg-gray-50 transition">
						<td class="px-6 py-4 font-medium text-gray-900">{{ job.title }}</td>
						<td class="px-6 py-4 text-xs text-gray-500">{{ job.user.email }}</td>
						<td class="px-6 py-4 text-xs text-gray-500">{{ job.created_at|date:"M d, Y - g:i A" }}</td>
						<td class="px-6 py-4 text-xs text-gray-500">
							<div class="max-h-48 overflow-y-auto whitespace-pre-wrap">
								{{ job.raw_text }}
							</div>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
			</div>
		</div>
		{% else %}
		<p class="px-6 py-10 text-center text-gray-500">No job descriptions found.</p>
		{% endif %}
	</section>

	<section class="bg-white rounded-3xl shadow-xl border border-gray-100">
		<header class="flex items-center justify-between px-6 py-5 border-b border-gray-100">
			<div>
				<h2 class="text-lg font-semibold text-gray-900">Match Attempts</h2>
				<p class="text-sm text-gray-500">Most recent 50 match runs.</p>
			</div>
			<i class="fas fa-chart-line text-blue-500 text-xl"></i>
		</header>
		{% if matches %}
		<div class="overflow-x-auto">
			<div class="max-h-96 overflow-y-auto">
			<table class="min-w-full divide-y divide-gray-100">
				<thead class="bg-gray-50 text-gray-600 text-xs uppercase tracking-wide">
					<tr>
						<th class="px-6 py-3 text-left">Candidate</th>
						<th class="px-6 py-3 text-left">Job Title</th>
						<th class="px-6 py-3 text-left">Final Score</th>
						<th class="px-6 py-3 text-left">Profession Match</th>
						<th class="px-6 py-3 text-left">Ran At</th>
					</tr>
				</thead>
				<tbody class="divide-y divide-gray-100 text-sm">
					{% for match in matches %}
					<tr class="hover:bg-gray-50 transition">
						<td class="px-6 py-4 text-sm text-gray-900">{{ match.user.email }}</td>
						<td class="px-6 py-4 text-sm text-gray-900">{{ match.job_description.title }}</td>
						<td class="px-6 py-4">
							<span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold {% if match.final_score >= 70 %}bg-green-100 text-green-700{% elif match.final_score >= 50 %}bg-yellow-100 text-yellow-700{% else %}bg-red-100 text-red-600{% endif %}">
								{{ match.final_score|floatformat:1 }}%
							</span>
						</td>
						<td class="px-6 py-4 text-xs">
							{% if match.profession_match_flag %}
							<span class="inline-flex items-center gap-1 text-green-600 font-semibold"><i class="fas fa-check-circle"></i>Aligned</span>
							{% else %}
							<span class="inline-flex items-center gap-1 text-red-600 font-semibold"><i class="fas fa-exclamation-triangle"></i>Mismatch</span>
							{% endif %}
						</td>
						<td class="px-6 py-4 text-xs text-gray-500">{{ match.created_at|date:"M d, Y - g:i A" }}</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
			</div>
		</div>
		{% else %}
		<p class="px-6 py-10 text-center text-gray-500">No match attempts found.</p>
		{% endif %}
	</section>
</div>
{% endblock %}
